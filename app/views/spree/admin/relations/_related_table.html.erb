<table class="table sortable" data-hook="products_table" data-sortable-link="<%= update_positions_admin_product_relations_url(@product) %>">
   <colgroup>
    <col style="width: 5%" />
    <col style="width: 30%" />
    <col style="width: 15%" />
    <col style="width: 15%" />
    <col style="width: 15%" />
    <col style="width: 15%" />
    <col style="width: 5%" />
  </colgroup>
  <thead>
    <tr data-hook="products_header">
      <th></th>
      <th><%= Spree.t(:name) %></th>
      <th><%= Spree.t(:sku) %></th>
      <th><%= Spree.t(:type) %></th>
      <th><%= Spree.t(:discount_amount) %></th>
      <th><%= Spree.t(:update) %></th>
      <th class="actions"></th>
    </tr>
  </thead>
  <tbody>
    <% object.relations.each do |relation| %>
      <tr id="<%= spree_dom_id relation %>" data-hook="products_row">
        <td class="handle move-handle">
          <span class="icon icon-move handle"></span>
        </td>
        <% product_relatable  = ( object.class.name == 'Spree::Product' ? relation.relatable : relation.relatable.product ) %>
        <% product_related_to = ( object.class.name == 'Spree::Product' ? relation.related_to : relation.related_to.product ) %>

        <td><%= link_to relation.related_to.name, product_related_to %></td>

        <td>
          <% if object.class.name == 'Spree::Variant' && !relation.related_to.is_master? %>
              <%= link_to relation.related_to.sku, admin_product_variant_path(product_related_to, relation.related_to) %>
          <% else %>
              <%= link_to relation.related_to.sku, product_related_to %>
          <% end %>
        </td>

        <td><%= relation.relation_type.name %></td>
        <%= form_for relation, url: admin_product_relation_path(product_relatable, relation) do |f| %>
          <td>
            <div class="input-group">
              <%= f.text_field :discount_amount, class: 'form-control text-center', id: "discount_#{f.object.id}" %>
            </div>
          </td>

          <td>
            <span class="input-group-btn">
              <%= link_to Spree.t(:update), "#copayment_div_#{f.object.id}", class: 'pull-right btn btn-primary submit-reaction', 'data-relation': f.object.id, 'data-product': @product.id %>
            </span>
          </td>
        <% end %>

        <td class="actions">
          <%= link_to_delete relation, url: admin_product_relation_url(product_relatable, relation), no_text: true %>
        </td>
      </tr>
    <% end %>
  </tbody>
</table>

<script type="text/javascript">
  $('.submit-reaction').on ('click', function() {
    relation_id = $(this).data('relation')

    discount = $("#discount_" + relation_id).val();

    $.ajax({
      dataType: 'html',
      url: ("/admin/products/" + $(this).data('product') + "product_id/relations/" + relation_id),
      type: 'put',
      data: { 'relation[discount_amount]': discount },
      success: function(data) {
        $('.flash').html('<div class="alert alert-success"><a class="close" data-dismiss="alert">×</a><span>'+ 'Actualizado con éxito' +'</span></div>')
      }
    });
  })
</script>
